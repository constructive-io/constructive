services:
  # Constructive GraphQL API server
  constructive-server:
    container_name: constructive-server
    image: constructive:dev
    build:
      context: .
      dockerfile: ./Dockerfile
    # The image entrypoint already runs the Constructive CLI (`constructive`).
    # We only need to provide the subcommand and flags here.
    entrypoint: ["constructive", "server", "--port", "3000", "--origin", "*", "--strictAuth", "false"]
    environment:
      NODE_ENV: development
      # Server
      PORT: "3000"
      SERVER_HOST: "0.0.0.0"
      SERVER_TRUST_PROXY: "true"
      SERVER_ORIGIN: "*"          # allow all origins in dev
      SERVER_STRICT_AUTH: "false"
      # Postgres connection (matches postgres service)
      PGHOST: postgres
      PGPORT: "5432"
      PGUSER: postgres
      PGPASSWORD: password
      PGDATABASE: launchql

      # Local secrets provider (Vault/OpenBao-compatible) for dev.
      # When combined with docker-compose.secrets.yml, an OpenBao/Vault
      # style dev instance runs at http://openbao:8200 with a root
      # token "root". This is for local development only.
      VAULT_ADDR: "http://openbao:8200"
      OPENBAO_ADDR: "http://openbao:8200"
      # For the dev Vault image, the default KV v2 engine is mounted at
      # the path "secret". Use that here for local testing; in
      # production you can override this via meta_public.secret_providers.config.
      OPENBAO_MOUNT_PATH: "secret"
      OPENBAO_MANAGEMENT_TOKEN: "root"

      # API meta configuration (static mode for dev)
      API_ENABLE_META: "true"
      API_EXPOSED_SCHEMAS: "collections_public,meta_public"
      API_ANON_ROLE: "administrator"
      API_ROLE_NAME: "administrator"
      API_DEFAULT_DATABASE_ID: "dbe"
    ports:
      - "3000:3000"
    networks:
      constructive-net:
        aliases:
          # Let other containers call the admin API using the seeded domain route.
          - admin.localhost

  # Simple email function (Knative-style HTTP function)
  simple-email:
    container_name: simple-email
    image: constructive:dev
    # Override the image entrypoint (Constructive CLI) and run the Node function directly.
    entrypoint: ["node", "functions/simple-email/dist/index.js"]
    environment:
      NODE_ENV: development
      LOG_LEVEL: info
      SIMPLE_EMAIL_DRY_RUN: "${SIMPLE_EMAIL_DRY_RUN:-true}"
      # Mailgun / email provider configuration for the Postmaster package
      # Replace with real credentials for local testing.
      MAILGUN_API_KEY: "${MAILGUN_API_KEY:-change-me-mailgun-api-key}"
      MAILGUN_KEY: "${MAILGUN_KEY:-change-me-mailgun-api-key}"
      MAILGUN_DOMAIN: "mg.constructive.io"
      MAILGUN_FROM: "no-reply@mg.constructive.io"
      MAILGUN_REPLY: "info@mg.constructive.io"
    ports:
      # Expose function locally (optional)
      - "8081:8080"
    networks:
      - constructive-net

  # Send email link function (invite, password reset, verification)
  send-email-link:
    container_name: send-email-link
    image: constructive:dev
    entrypoint: ["node", "functions/send-email-link/dist/index.js"]
    environment:
      NODE_ENV: development
      LOG_LEVEL: info
      DEFAULT_DATABASE_ID: "dbe"
      # Constructive selects the API by Host header; use a seeded domain route.
      GRAPHQL_URL: "http://admin.localhost:3000/graphql"
      META_GRAPHQL_URL: "http://admin.localhost:3000/graphql"
      # Optional: provide an existing API token (Bearer) if your server requires it.
      GRAPHQL_AUTH_TOKEN: "${GRAPHQL_AUTH_TOKEN:-}"
      # Mailgun / email provider configuration for the Postmaster package
      MAILGUN_API_KEY: "${MAILGUN_API_KEY:-change-me-mailgun-api-key}"
      MAILGUN_KEY: "${MAILGUN_KEY:-change-me-mailgun-api-key}"
      MAILGUN_DOMAIN: "mg.constructive.io"
      MAILGUN_FROM: "no-reply@mg.constructive.io"
      MAILGUN_REPLY: "info@mg.constructive.io"
      # Local dashboard port for generated links, used only for
      # localhost-style hosts in DRY RUN mode:
      # http://localhost:LOCAL_APP_PORT/...
      LOCAL_APP_PORT: "3000"
      SEND_EMAIL_LINK_DRY_RUN: "${SEND_EMAIL_LINK_DRY_RUN:-true}"
    ports:
      # Expose function locally (optional)
      - "8082:8080"
    networks:
      - constructive-net

  # Jobs runtime: callback server + worker + scheduler
  knative-job-service:
    container_name: knative-job-service
    image: constructive:dev
    # Override the image entrypoint and run the jobs runtime directly.
    entrypoint: ["node", "jobs/knative-job-service/dist/run.js"]
    depends_on:
      - simple-email
      - send-email-link
    environment:
      NODE_ENV: development

      # Postgres (jobs extension lives in this DB)
      PGUSER: postgres
      PGHOST: postgres
      PGPASSWORD: password
      PGPORT: "5432"
      PGDATABASE: launchql
      JOBS_SCHEMA: app_jobs

      # Worker configuration
      JOBS_SUPPORT_ANY: "false"
      JOBS_SUPPORTED: "simple-email,send-email-link"
      HOSTNAME: "knative-job-service-1"

      # Callback HTTP server (job completion callbacks)
      INTERNAL_JOBS_CALLBACK_PORT: "8080"
      INTERNAL_JOBS_CALLBACK_URL: "http://knative-job-service:8080/callback"
      # Hostname used by job-utils.getCallbackBaseUrl for callbacks
      JOBS_CALLBACK_HOST: "knative-job-service"

      # Function gateway base URL (used by worker when no dev map is present)
      INTERNAL_GATEWAY_URL: "http://simple-email:8080"

      # Development-only map from task identifier -> function URL
      # Used by @constructive-io/knative-job-worker when NODE_ENV !== 'production'.
      # This lets the worker call the function containers directly in docker-compose.
      INTERNAL_GATEWAY_DEVELOPMENT_MAP: '{"simple-email":"http://simple-email:8080","send-email-link":"http://send-email-link:8080"}'

    ports:
      - "8080:8080"
    networks:
      - constructive-net

networks:
  constructive-net:
    external: true
    name: constructive-net
