services:
  # Constructive Admin GraphQL API server (internal, header-based routing)
  constructive-admin-server:
    container_name: constructive-admin-server
    image: constructive:dev
    build:
      context: .
      dockerfile: ./Dockerfile
    entrypoint: ["constructive", "server", "--host", "0.0.0.0", "--port", "3000", "--origin", "*"]
    environment:
      NODE_ENV: development
      # Server
      PORT: "3000"
      SERVER_HOST: "0.0.0.0"
      SERVER_TRUST_PROXY: "true"
      SERVER_ORIGIN: "*"
      SERVER_STRICT_AUTH: "false"
      # Postgres connection (matches postgres service)
      PGHOST: postgres
      PGPORT: "5432"
      PGUSER: postgres
      PGPASSWORD: password
      PGDATABASE: constructive
      # Api configuration
      API_ENABLE_SERVICES: "true"
      API_EXPOSED_SCHEMAS: "metaschema_public,services_public,constructive_auth_public"
      # API_IS_PUBLIC=false enables header-based routing (X-Api-Name, X-Database-Id, X-Meta-Schema)
      API_IS_PUBLIC: "false"
      # Meta schemas used for schema validation and X-Meta-Schema routing
      API_META_SCHEMAS: "metaschema_public,services_public,metaschema_modules_public,constructive_auth_public"
      API_ANON_ROLE: "administrator"
      API_ROLE_NAME: "administrator"
    ports:
      - "3002:3000"
    networks:
      constructive-net:
        aliases:
          - constructive-admin-server

  # Constructive Public GraphQL API server (external, domain-based routing)
  constructive-server:
    container_name: constructive-server
    image: constructive:dev
    entrypoint: ["constructive", "server", "--host", "0.0.0.0", "--port", "3000", "--origin", "*"]
    environment:
      NODE_ENV: development
      # Server
      PORT: "3000"
      SERVER_HOST: "0.0.0.0"
      SERVER_TRUST_PROXY: "true"
      SERVER_ORIGIN: "*"
      SERVER_STRICT_AUTH: "false"
      # Postgres connection (matches postgres service)
      PGHOST: postgres
      PGPORT: "5432"
      PGUSER: postgres
      PGPASSWORD: password
      PGDATABASE: constructive
      # Api configuration
      API_ENABLE_SERVICES: "false"
      API_EXPOSED_SCHEMAS: "metaschema_public,services_public,constructive_auth_public"
      # Public-facing server
      API_IS_PUBLIC: "true"
      # Meta schemas used for schema validation
      API_META_SCHEMAS: "metaschema_public,services_public,metaschema_modules_public,constructive_auth_public"
      API_ANON_ROLE: "anonymous"
      API_ROLE_NAME: "authenticated"
    ports:
      - "3000:3000"
    networks:
      constructive-net:
        aliases:
          - constructive-server

  # Send email link function (invite, password reset, verification)
  send-email-link:
    container_name: send-email-link
    image: constructive:dev
    entrypoint: ["node", "functions/send-email-link/dist/index.js"]
    environment:
      NODE_ENV: development
      LOG_LEVEL: info
      DEFAULT_DATABASE_ID: "dbe"
      # Point to admin server (uses X-Api-Name header routing when API_IS_PUBLIC=false)
      GRAPHQL_URL: "http://constructive-admin-server:3000/graphql"
      META_GRAPHQL_URL: "http://constructive-admin-server:3000/graphql"
      # API name for header-based routing (X-Api-Name header) - kept for future use
      GRAPHQL_API_NAME: "private"
      # Optional: provide an existing API token (Bearer) if your server requires it.
      GRAPHQL_AUTH_TOKEN: "${GRAPHQL_AUTH_TOKEN:-}"
      # Mailgun / email provider configuration for the Postmaster package
      MAILGUN_API_KEY: "${MAILGUN_API_KEY:-change-me-mailgun-api-key}"
      MAILGUN_KEY: "${MAILGUN_KEY:-change-me-mailgun-api-key}"
      MAILGUN_DOMAIN: "mg.constructive.io"
      MAILGUN_FROM: "no-reply@mg.constructive.io"
      MAILGUN_REPLY: "info@mg.constructive.io"
      # Local dashboard port for generated links, used only for
      # localhost-style hosts in DRY RUN mode:
      # http://localhost:LOCAL_APP_PORT/...
      LOCAL_APP_PORT: "3000"
      SEND_EMAIL_LINK_DRY_RUN: "${SEND_EMAIL_LINK_DRY_RUN:-true}"
    ports:
      - "8082:8080"
    networks:
      - constructive-net

  # Jobs runtime: callback server + worker + scheduler
  knative-job-service:
    container_name: knative-job-service
    image: constructive:dev
    entrypoint: ["node", "jobs/knative-job-service/dist/run.js"]
    depends_on:
      - send-email-link
    environment:
      NODE_ENV: development

      # Postgres (jobs extension lives in this DB)
      PGUSER: postgres
      PGHOST: postgres
      PGPASSWORD: password
      PGPORT: "5432"
      PGDATABASE: constructive
      JOBS_SCHEMA: app_jobs

      # Worker configuration
      JOBS_SUPPORT_ANY: "false"
      JOBS_SUPPORTED: "send-email-link"
      HOSTNAME: "knative-job-service-1"

      # Callback HTTP server (job completion callbacks)
      INTERNAL_JOBS_CALLBACK_PORT: "8080"
      INTERNAL_JOBS_CALLBACK_URL: "http://knative-job-service:8080/callback"
      # Hostname used by job-utils.getCallbackBaseUrl for callbacks
      JOBS_CALLBACK_HOST: "knative-job-service"

      # Function gateway base URL (used by worker when no dev map is present)
      INTERNAL_GATEWAY_URL: "http://send-email-link:8080"

      # Development-only map from task identifier -> function URL
      INTERNAL_GATEWAY_DEVELOPMENT_MAP: '{"send-email-link":"http://send-email-link:8080"}'

    ports:
      - "8080:8080"
    networks:
      - constructive-net

networks:
  constructive-net:
    external: true
    name: constructive-net
