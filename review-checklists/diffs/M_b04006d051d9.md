# Diff â€” `M` `AGENTS.md`

## Context
- Base: `main` @ `86d74dc4fce9051df0d2b5bcc163607aba42f009`
- Head: `refactor/ensure-new-name-mappings` @ `bd9be723c96aeb1f9f69e4946acbd9241ee8da50`
- Merge base: `86d74dc4fce9051df0d2b5bcc163607aba42f009`
- Numstat: `+61/-250`
- Reproduce: `git diff main...HEAD -- AGENTS.md`

## Guideline token summary
- Deltas: `Constructive`: 3 â†’ 8; `constructive`: 0 â†’ 5; `launchql`: 3 â†’ 0; `cnc`: 0 â†’ 2; `GraphQLServer`: 0 â†’ 1; `lql`: 1 â†’ 0

## Side-by-side diff (only changed lines)
- Left = `main`, Right = `HEAD`
- Legend: `|` changed, `<` only in `main`, `>` only in `HEAD`

```text
This guide helps AI agents quickly navigate and understand the Constructive codebase without having to read everythin |	This guide helps AI agents quickly navigate the Constructive monorepo. Constructive provides tooling for building sec
## ðŸŽ¯ Quick Start for Agents											      |	## Quick Start
**Most Important Packages to Know First:**									      |	**Most important packages to know first:**
1. **`packages/core`** - Main orchestration and migration engine ([detailed guide](packages/core/AGENTS.md))	      |	1. **`pgpm/core`** â€“ PGPM engine: migrations, packaging, dependency resolution ([guide](pgpm/core/AGENTS.md))
2. **`packages/cli`** - Command-line interface and user workflows ([detailed guide](packages/cli/AGENTS.md))	      |	2. **`pgpm/pgpm`** â€“ PGPM CLI: database/workspace commands (init/add/deploy/verify/etc)
3. **`packages/pgsql-test`** - Testing infrastructure ([detailed guide](packages/pgsql-test/AGENTS.md))		      |	3. **`packages/cli`** â€“ Constructive CLI (`constructive` / `cnc`), delegates PGPM commands and adds GraphQL workflo
4. **`packages/server`** - GraphQL API server									      |	4. **`postgres/pgsql-test`** â€“ PostgreSQL test harness and seed adapters ([guide](postgres/pgsql-test/AGENTS.md))
5. **`packages/types`** - TypeScript type definitions								      |	5. **`graphql/server`** â€“ Constructive GraphQL server (Express + PostGraphile)
														      >	6. **`graphql/codegen`** â€“ GraphQL code generation (types/ops/sdk)
**Key Classes to Understand:**											      |	**Key classes and entry points:**
- **`PgpmPackage`** (`packages/core/src/core/class/pgpm.ts`) - Workspace and module management			      |	- **`PgpmPackage`** â€“ `pgpm/core/src/core/class/pgpm.ts`
- **`PgpmMigrate`** (`packages/core/src/migrate/client.ts`) - Database migration operations			      |	- **`PgpmMigrate`** â€“ `pgpm/core/src/migrate/client.ts`
														      >	- **`GraphQLServer`** â€“ `graphql/server/src/server.ts`
## ðŸ“¦ Package Categories											      |	## Monorepo Layout
### ðŸ—ï¸ Core Framework											      |	- **`packages/*`** â€“ Constructive CLI + misc packages (`client`, `orm`, `query-builder`, `url-domains`, `server-uti
| Package | Purpose | Key Files |										      |	- **`pgpm/*`** â€“ PGPM engine + CLI + shared types/logger/env
|---------|---------|-----------|										      |	- **`graphql/*`** â€“ GraphQL server, explorer, codegen, types/env, query/react utilities
| **`core`** | Main orchestration, migrations, dependency resolution | `src/core/class/pgpm.ts`, `src/migrate/client. |	- **`postgres/*`** â€“ PostgreSQL tooling and tests (`pg-ast`, `pg-codegen`, `introspectron`, `pgsql-test`, etc.)
| **`cli`** | Command-line interface (`lql` command) | `src/commands.ts`, `src/commands/deploy.ts` |		      |	- **`streaming/*`** â€“ S3 helpers and stream hashing utilities
| **`types`** | TypeScript type definitions | `src/pgpm.ts` |							      |	- **`extensions/*`** â€“ PGPM extension modules (Postgres extensions packaged as PGPM modules)
| **`env`** | Environment and configuration management | - |							      |	- **`graphile/*`** â€“ Graphile/PostGraphile plugins (kept under their own namespace)
														      >	- **`jobs/*`**, **`functions/*`**, **`sandbox/*`** â€“ supporting systems and examples
### ðŸš€ API & Server												      |	## Entry Points
| Package | Purpose | Key Files |										      <	
|---------|---------|-----------|										      <	
| **`server`** | Express + PostGraphile GraphQL API server | `src/middleware/api.ts` |				      <	
| **`explorer`** | GraphiQL API browser/debugger | - |								      <	
| **`graphile-settings`** | PostGraphile configuration utilities | - |						      <	
| **`graphile-cache`** | Caching for GraphQL operations | - |							      <	
| **`graphile-test`** | GraphQL testing utilities | - |								      <	
| **`graphile-query`** | GraphQL query building | - |								      <	
### ðŸ§ª Testing Infrastructure											      |	### PGPM CLI (`pgpm`)
| Package | Purpose | Key Files |										      <	
|---------|---------|-----------|										      <	
| **`pgsql-test`** | Isolated PostgreSQL test environments | `src/test-client.ts` |				      <	
| **`pg-query-context`** | Session context injection for tests | - |						      <	
### ðŸ”„ Database & Migration											      |	- **Router:** `pgpm/pgpm/src/commands.ts`
| Package | Purpose | Key Files |										      |	- **Executable:** `pgpm/pgpm/src/index.ts`
|---------|---------|-----------|										      |	- **Command implementations:** `pgpm/pgpm/src/commands/*`
| **`pg-env`** | PostgreSQL environment configuration | - |							      <	
| **`pg-cache`** | PostgreSQL connection pooling | - |								      <	
| **`pg-codegen`** | Code generation from PostgreSQL schemas | - |						      <	
| **`introspectron`** | PostgreSQL schema introspection | - |							      <	
### ðŸ§  Parsing & AST												      |	### Constructive CLI (`constructive` / `cnc`)
| Package | Purpose | Key Files |										      <	
|---------|---------|-----------|										      <	
| **`pg-ast`** | PostgreSQL AST tools and transformations | - |							      <	
| **`gql-ast`** | GraphQL AST utilities | - |									      <	
### ðŸ” Streaming & File Handling										      |	- **Router:** `packages/cli/src/commands.ts`
| Package | Purpose | Key Files |										      |	- **Local GraphQL commands:** `packages/cli/src/commands/*`
|---------|---------|-----------|										      |	- **Delegated PGPM commands:** sourced from `pgpm/pgpm`
| **`s3-streamer`** | Direct S3 streaming for large files | - |							      <	
| **`s3-utils`** | S3 utilities and helpers | - |								      <	
| **`etag-hash`** | S3-compatible ETag generation | - |								      <	
| **`etag-stream`** | ETag computation via streams | - |							      <	
| **`stream-to-etag`** | Stream-to-ETag transformation | - |							      <	
| **`uuid-hash`** | Deterministic UUID generation | - |								      <	
| **`uuid-stream`** | Streaming UUID generation | - |								      <	
| **`upload-names`** | Collision-resistant filename utilities | - |						      <	
| **`content-type-stream`** | Content type detection in streams | - |						      <	
| **`mime-bytes`** | MIME type utilities | - |									      <	
### ðŸ—ï¸ Query Building & Code Generation									      |	### GraphQL Server
| Package | Purpose | Key Files |										      <	
|---------|---------|-----------|										      <	
| **`query-builder`** | TypeScript SQL query builder | - |							      <	
| **`query`** | Fluent GraphQL query builder | - |								      <	
| **`launchql-gen`** | Auto-generated GraphQL mutations/queries | - |						      <	
| **`client`** | Client-side utilities | - |									      <	
| **`react`** | React integration components | - |								      <	
### ðŸ› ï¸ Development Tools											      |	- **Entry:** `graphql/server/src/index.ts`
| Package | Purpose | Key Files |										      |	- **Server implementation:** `graphql/server/src/server.ts`
|---------|---------|-----------|										      |	- **Schema wiring:** `graphql/server/src/schema.ts`
| **`templatizer`** | Template rendering system | - |								      <	
| **`logger`** | Logging utilities | - |									      <	
| **`url-domains`** | URL and domain utilities | - |								      <	
| **`server-utils`** | Server utility functions | - |								      <	
| **`orm`** | Object-relational mapping utilities | - |								      <	
## ðŸ”‘ Key Classes and Entry Points										      |	## Common Workflows (via CLI)
### PgpmPackage Class												      |	- Initialize workspace/module: `pgpm init workspace`, `pgpm init` (also available via `constructive init`)
**Location:** `packages/core/src/core/class/pgpm.ts`								      |	- Create a change: `pgpm add <change>`
														      >	- Deploy/verify/revert: `pgpm deploy`, `pgpm verify`, `pgpm revert`
														      >	- Install PGPM modules: `pgpm install <pkg@version>`
														      >	- Start GraphQL server/explorer: `constructive server`, `constructive explorer`
**Purpose:** High-level orchestration for workspace and module management					      |	## Tips
**Key Methods:**												      |	1. Start with `pgpm/core/AGENTS.md` to understand the migration and plan model.
- `deploy(opts, target?, recursive?)` - Deploy modules to database						      |	2. Use `packages/cli/AGENTS.md` to understand Constructiveâ€™s command routing.
- `revert(opts, target?)` - Revert database changes								      |	3. Use `postgres/pgsql-test/AGENTS.md` for patterns around isolated test DBs and seeding.
\ No newline at end of file

- `verify(opts, target?)` - Verify database state								      <	
- `getModuleMap()` - Get all available modules									      <	
- `initModule(options)` - Initialize new module									      <	
- `installModules(...packages)` - Install module dependencies							      <	
- `addTag(tagName, changeName?, comment?)` - Tag changes for versioning						      <	
														      <	
**Context Detection:**												      <	
- `getContext()` - Determine if in workspace, module, or outside						      <	
- `isInWorkspace()` / `isInModule()` - Context checks								      <	
														      <	
### PgpmMigrate Class												      <	
**Location:** `packages/core/src/migrate/client.ts`								      <	
														      <	
**Purpose:** Low-level database migration operations								      <	
														      <	
**Key Methods:**												      <	
- `deploy(options)` - Deploy changes to database								      <	
- `revert(options)` - Revert changes from database								      <	
- `verify(options)` - Verify deployed changes									      <	
- `status(packageName?)` - Get deployment status								      <	
- `isDeployed(packageName, changeName)` - Check if change is deployed						      <	
- `initialize()` - Set up migration schema									      <	
														      <	
**Configuration:**												      <	
- Supports `content` or `ast` hash methods for SQL files							      <	
- Configurable via `PgpmMigrateOptions`										      <	
														      <	
### CLI Command Structure											      <	
**Location:** `packages/cli/src/commands.ts`									      <	
														      <	
**Main Commands:**												      <	
- `deploy` - Deploy database changes										      <	
- `revert` - Revert database changes  										      <	
- `verify` - Verify database state										      <	
- `init` - Initialize workspace or module									      <	
- `server` - Start development server										      <	
- `explorer` - Launch GraphiQL explorer										      <	
- `migrate` - Migration management										      <	
- `install` - Install module dependencies									      <	
- `tag` - Version management											      <	
														      <	
**Command Pattern:** All commands follow the pattern:								      <	
```typescript													      <	
export default async (argv: ParsedArgs, prompter: Inquirerer, options: CLIOptions) => {				      <	
  // Command implementation											      <	
}														      <	
```														      <	
														      <	
## ðŸš€ Common Workflows											      <	
														      <	
### 1. Module Development Workflow										      <	
```typescript													      <	
// 1. Initialize workspace											      <	
const pkg = new PgpmPackage(cwd);										      <	
pkg.initWorkspace();												      <	
														      <	
// 2. Create module												      <	
pkg.initModule({												      <	
  name: 'my-module',												      <	
  description: 'My module',											      <	
  author: 'Developer',												      <	
  extensions: ['uuid-ossp']											      <	
});														      <	
														      <	
// 3. Deploy changes												      <	
await pkg.deploy(options);											      <	
```														      <	
														      <	
### 2. Testing Workflow												      <	
```typescript													      <	
// Set up isolated test database										      <	
import { getConnections } from 'pgsql-test';									      <	
														      <	
const { db, teardown } = await getConnections();								      <	
await db.query('SELECT 1'); // Ready for testing								      <	
```														      <	
														      <	
### 3. Migration Workflow											      <	
```typescript													      <	
// Direct migration operations											      <	
const migrate = new PgpmMigrate(pgConfig);									      <	
await migrate.deploy({ modulePath: './my-module' });								      <	
await migrate.verify({ modulePath: './my-module' });								      <	
```														      <	
														      <	
## ðŸ“ File Structure Patterns											      <	
														      <	
### Module Structure												      <	
```														      <	
my-module/													      <	
â”œâ”€â”€ pgpm.plan          # Migration plan									      <	
â”œâ”€â”€ my-module.control      # Extension metadata								      <	
â”œâ”€â”€ Makefile              # Build configuration								      <	
â”œâ”€â”€ deploy/               # Deploy scripts								      <	
â”‚   â”œâ”€â”€ init.sql											      <	
â”‚   â””â”€â”€ tables.sql											      <	
â”œâ”€â”€ revert/               # Revert scripts								      <	
â”‚   â”œâ”€â”€ tables.sql											      <	
â”‚   â””â”€â”€ init.sql											      <	
â””â”€â”€ verify/               # Verification scripts								      <	
    â”œâ”€â”€ init.sql												      <	
    â””â”€â”€ tables.sql											      <	
```														      <	
														      <	
### Workspace Structure												      <	
```														      <	
workspace/													      <	
â”œâ”€â”€ launchql.config.js    # Workspace configuration							      <	
â”œâ”€â”€ packages/             # Module packages								      <	
â”‚   â”œâ”€â”€ module-a/											      <	
â”‚   â””â”€â”€ module-b/											      <	
â””â”€â”€ extensions/           # Installed extensions								      <	
```														      <	
														      <	
## ðŸ” Finding Specific Functionality										      <	
														      <	
### For Database Operations											      <	
- **Migrations:** `packages/core/src/migrate/`									      <	
- **Schema introspection:** `packages/introspectron/`								      <	
- **Connection management:** `packages/pg-cache/`, `packages/pg-env/`						      <	
														      <	
### For API Development												      <	
- **GraphQL server:** `packages/server/`									      <	
- **Query building:** `packages/query/`, `packages/query-builder/`						      <	
- **Code generation:** `packages/launchql-gen/`									      <	
														      <	
### For Testing													      <	
- **Test infrastructure:** `packages/pgsql-test/`								      <	
- **GraphQL testing:** `packages/graphile-test/`								      <	
- **Context injection:** `packages/pg-query-context/`								      <	
														      <	
### For File Operations												      <	
- **S3 streaming:** `packages/s3-streamer/`									      <	
- **File hashing:** `packages/etag-hash/`, `packages/uuid-hash/`						      <	
- **Upload handling:** `packages/upload-names/`									      <	
														      <	
## ðŸ“š Additional Resources											      <	
														      <	
- **Package-specific guides:** See `packages/*/AGENTS.md` for detailed documentation				      <	
- **Type definitions:** `packages/types/src/` for comprehensive TypeScript interfaces				      <	
- **Examples:** `sandbox/` directory contains example projects							      <	
- **Tests:** Each package's `__tests__/` directory shows usage patterns						      <	
														      <	
## ðŸŽ¯ Agent Tips												      <	
														      <	
1. **Start with `packages/core/AGENTS.md`** for deep understanding of the main classes				      <	
2. **Check `packages/cli/AGENTS.md`** to understand user-facing workflows					      <	
3. **Use `packages/pgsql-test/AGENTS.md`** for testing patterns							      <	
4. **Look at existing tests** in `__tests__/` directories for usage examples					      <	
5. **Check `package.json` files** to understand dependencies between packages					      <	
6. **Use the type definitions** in `packages/types/` to understand interfaces					      <	
														      <	
This navigation guide should help you quickly find the right code without reading the entire codebase. For detailed i <
```
