# Diff â€” `M` `packages/cli/AGENTS.md`

## Context
- Base: `main` @ `86d74dc4fce9051df0d2b5bcc163607aba42f009`
- Head: `refactor/ensure-new-name-mappings` @ `bd9be723c96aeb1f9f69e4946acbd9241ee8da50`
- Merge base: `86d74dc4fce9051df0d2b5bcc163607aba42f009`
- Numstat: `+27/-478`
- Reproduce: `git diff main...HEAD -- packages/cli/AGENTS.md`

## Guideline token summary
- Deltas: `lql`: 24 â†’ 0; `Constructive`: 0 â†’ 8; `LaunchQL`: 6 â†’ 0; `@constructive-io/`: 0 â†’ 3; `@launchql/`: 2 â†’ 0; `constructive`: 2 â†’ 4; `launchql`: 2 â†’ 0; `cnc`: 0 â†’ 1

## Side-by-side diff (only changed lines)
- Left = `main`, Right = `HEAD`
- Legend: `|` changed, `<` only in `main`, `>` only in `HEAD`

```text
# LaunchQL CLI Package - Agent Guide										      |	# Constructive CLI Package - Agent Guide
The `@launchql/cli` package provides the command-line interface for LaunchQL, exposing all framework functionality th |	The `@constructive-io/cli` package provides the user-facing CLI for the Constructive ecosystem.
## ðŸŽ¯ Overview												      |	- **Binaries:** `constructive` (full) and `cnc` (shorthand)
														      >	- **What it covers:** PGPM database workflows (via the `pgpm` package) plus Constructive GraphQL workflows (server, e
**Main Purpose:** User-facing command-line toolkit for managing LaunchQL projects, supporting database scaffolding, m |	## Entry Points
**Binary:** `lql` (LaunchQL command-line tool)									      |	- **Router:** `packages/cli/src/commands.ts`
														      >	  - Builds a command map by merging `createPgpmCommandMap()` (from the `pgpm` package) with Constructive GraphQL comm
														      >	- **Executable:** `packages/cli/src/index.ts` (compiled to `dist/index.js`)
**Key Features:**												      |	## Command Sources
- Database-first development workflow										      <	
- Module system with dependency management									      <	
- Smart migrations with automated deployment									      <	
- Development server with hot-reload										      <	
- Production-ready deployment plans										      <	
## ðŸ—ï¸ CLI Architecture											      |	### PGPM Commands (delegated)
### Main Entry Point												      |	Most database/workspace commands are delegated to the `pgpm` package via `createPgpmCommandMap()`:
**File:** `src/commands.ts`											      <	
**Command Structure:**												      |	- `init`, `add`, `deploy`, `revert`, `verify`, `plan`, `package`, `export`, `migrate`, `install`, `extension`, `tag`,
```typescript													      <	
export const commands = async (											      <	
  argv: Partial<ParsedArgs>, 											      <	
  prompter: Inquirerer, 											      <	
  options: CLIOptions & { skipPgTeardown?: boolean }								      <	
) => {														      <	
  // Command routing and execution										      <	
}														      <	
```														      <	
**Connection Management:**											      |	Implementation lives under:
All commands (except `server` and `explorer`) are wrapped with `withPgTeardown()` to ensure proper PostgreSQL connect <	
### Command Map													      |	- `pgpm/pgpm/src/commands/*` (CLI behavior)
**Available Commands:**												      |	- `pgpm/core/src/*` (core engine)
```typescript													      <	
const commandMap = {												      <	
  'admin-users': adminUsers,    // User management								      <	
  'clear': clear,               // Clear/cleanup operations							      <	
  'deploy': deploy,             // Deploy database changes							      <	
  'verify': verify,             // Verify database state							      <	
  'revert': revert,             // Revert database changes							      <	
  'remove': remove,             // Remove changes from plan							      <	
  'init': init,                 // Initialize workspace/module							      <	
  'extension': extension,       // Manage module dependencies							      <	
  'plan': plan,                 // Generate deployment plans							      <	
  'export': _export,            // Export migrations								      <	
  'package': _package,          // Package modules								      <	
  'tag': tag,                   // Version management								      <	
  'kill': kill,                 // Cleanup connections/databases						      <	
  'install': install,           // Install module dependencies							      <	
  'migrate': migrate,           // Migration management								      <	
  'analyze': analyze,           // Analyze modules								      <	
  'rename': rename,             // Rename modules								      <	
  'server': server,             // Development server								      <	
  'explorer': explorer          // GraphiQL explorer								      <	
};														      <	
```														      <	
## ðŸš€ Core Commands												      |	### Constructive GraphQL Commands (local)
### 1. Deploy Command												      |	These are implemented directly in this package:
**File:** `src/commands/deploy.ts`										      <	
**Purpose:** Deploy database changes and migrations to target database						      <	
**Usage:**													      |	- `packages/cli/src/commands/server.ts` â€“ start the Constructive GraphQL server
```bash														      |	- `packages/cli/src/commands/explorer.ts` â€“ start the Constructive GraphQL explorer
lql deploy [OPTIONS]												      |	- `packages/cli/src/commands/get-graphql-schema.ts` â€“ emit schema SDL (DB build or endpoint introspection)
```														      |	- `packages/cli/src/commands/codegen.ts` â€“ run GraphQL codegen (`@constructive-io/graphql-codegen`)
**Key Options:**												      |	## Debugging Tips
- `--createdb` - Create database if it doesn't exist								      <	
- `--recursive` - Deploy recursively through dependencies (default)						      <	
- `--package <name>` - Target specific package									      <	
- `--to <target>` - Deploy to specific change or tag								      <	
- `--tx` - Use transactions (default: true)									      <	
- `--fast` - Use fast deployment strategy									      <	
- `--logOnly` - Log-only mode, skip script execution								      <	
- `--usePlan` - Use deployment plan										      <	
- `--cache` - Enable caching											      <	
**Implementation Pattern:**											      |	- **Command routing:** `packages/cli/src/commands.ts`
```typescript													      |	- **Schema generation:** `packages/cli/src/commands/get-graphql-schema.ts` delegates schema building to `@constructiv
export default async (												      |	- **PG connections cleanup:** PGPM commands are wrapped to teardown `pg-cache` pools after execution (see `pgpm/pgpm/
  argv: Partial<ParsedArgs>,											      <	
  prompter: Inquirerer,												      <	
  _options: CLIOptions												      <	
) => {														      <	
  // 1. Show usage if requested											      <	
  if (argv.help || argv.h) {											      <	
    console.log(deployUsageText);										      <	
    process.exit(0);												      <	
  }														      <	
  // 2. Get target database											      |	## Tests
  const database = await getTargetDatabase(argv, prompter, {							      <	
    message: 'Select database'											      <	
  });														      <	
  // 3. Prompt for confirmation and options									      |	- `packages/cli/__tests__/*` covers both delegated PGPM commands (through the Constructive CLI router) and the local 
  const { yes, tx, fast, logOnly } = await prompter.prompt(argv, questions);					      <	
														      <	
  // 4. Create database if requested										      <	
  if (createdb) {												      <	
    execSync(`createdb ${database}`, {										      <	
      env: getSpawnEnvWithPg(pgEnv)										      <	
    });														      <	
  }														      <	
														      <	
  // 5. Execute deployment											      <	
  const project = new PgpmPackage(cwd);										      <	
  await project.deploy(opts, target, recursive);								      <	
}														      <	
```														      <	
														      <	
### 2. Init Command												      <	
**File:** `src/commands/init.ts`										      <	
**Purpose:** Initialize new LaunchQL workspace or module							      <	
														      <	
**Subcommands:**												      <	
- **Workspace Init:** `src/commands/init/workspace.ts`								      <	
- **Module Init:** `src/commands/init/module.ts`								      <	
														      <	
**Usage:**													      <	
```bash														      <	
lql init workspace     # Initialize workspace									      <	
lql init               # Initialize module (in workspace)							      <	
```														      <	
														      <	
**Template Options:**												      <	
- `--repo <repo>` - Use templates from GitHub repository (e.g., `owner/repo`)					      <	
- `--template-path <path>` - Use templates from local path							      <	
- `--from-branch <branch>` - Specify branch when using `--repo` (default: `main`)				      <	
														      <	
**Examples:**													      <	
```bash														      <	
lql init workspace --repo constructive-io/constructive								      <	
lql init workspace --template-path ./custom-templates								      <	
lql init --repo owner/repo --from-branch develop								      <	
```														      <	
														      <	
**Implementation:**												      <	
- Supports loading templates from GitHub repositories or local paths						      <	
- Automatically detects template type (workspace vs module)							      <	
- Uses `create-gen-app` scaffolding with cached boilerplates (via the shared `pgpm` init flow)			      <	
														      <	
### 3. Server Command												      <	
**File:** `src/commands/server.ts`										      <	
**Purpose:** Start GraphQL development server with hot-reload							      <	
														      <	
**Features:**													      <	
- PostGraphile-powered GraphQL API										      <	
- Automatic schema generation from database									      <	
- Hot-reload on database changes										      <	
- GraphiQL interface												      <	
- CORS configuration												      <	
														      <	
### 4. Migrate Command												      <	
**File:** `src/commands/migrate.ts`										      <	
**Purpose:** Comprehensive migration management									      <	
														      <	
**Subcommands:**												      <	
- `init` - Initialize migration tracking									      <	
- `status` - Check migration status										      <	
- `list` - List all changes											      <	
- `deps` - Show change dependencies										      <	
														      <	
**Subcommand Files:**												      <	
- `src/commands/migrate/status.ts`										      <	
- `src/commands/migrate/list.ts`										      <	
- `src/commands/migrate/deps.ts`										      <	
														      <	
### 5. Extension Command											      <	
**File:** `src/commands/extension.ts`										      <	
**Purpose:** Interactively manage module dependencies								      <	
														      <	
**Features:**													      <	
- Interactive dependency selection										      <	
- Automatic .control file updates										      <	
- Dependency validation												      <	
														      <	
## ðŸŽ® Command Patterns											      <	
														      <	
### Standard Command Structure											      <	
All CLI commands follow this pattern:										      <	
														      <	
```typescript													      <	
export default async (												      <	
  argv: Partial<ParsedArgs>,      // Command-line arguments							      <	
  prompter: Inquirerer,           // Interactive prompting							      <	
  options: CLIOptions             // CLI options								      <	
) => {														      <	
  // 1. Help handling												      <	
  if (argv.help || argv.h) {											      <	
    console.log(usageText);											      <	
    process.exit(0);												      <	
  }														      <	
														      <	
  // 2. Argument processing and prompting									      <	
  const answers = await prompter.prompt(argv, questions);							      <	
														      <	
  // 3. Validation and confirmation										      <	
  if (!answers.confirmed) {											      <	
    log.info('Operation cancelled.');										      <	
    return;													      <	
  }														      <	
														      <	
  // 4. Core logic execution											      <	
  const project = new PgpmPackage(cwd);										      <	
  await project.someOperation(options);										      <	
														      <	
  // 5. Success reporting											      <	
  log.success('Operation complete.');										      <	
  return argv;													      <	
};														      <	
```														      <	
														      <	
### Interactive Prompting											      <	
Commands use the `Inquirerer` for interactive prompts:								      <	
														      <	
```typescript													      <	
const questions: Question[] = [											      <	
  {														      <	
    type: 'confirm',												      <	
    name: 'confirmed',												      <	
    message: 'Are you sure you want to proceed?',								      <	
    required: true												      <	
  },														      <	
  {														      <	
    type: 'text',												      <	
    name: 'database',												      <	
    message: 'Database name',											      <	
    required: true												      <	
  },														      <	
  {														      <	
    type: 'autocomplete',											      <	
    name: 'package',												      <	
    message: 'Select package',											      <	
    options: availablePackages											      <	
  }														      <	
];														      <	
														      <	
const answers = await prompter.prompt(argv, questions);								      <	
```														      <	
														      <	
### Database Selection												      <	
**File:** `src/utils/database.ts`										      <	
														      <	
**Key Function:**												      <	
```typescript													      <	
export async function getTargetDatabase(									      <	
  argv: Partial<ParsedArgs>,											      <	
  prompter: Inquirerer,												      <	
  options: { message: string }											      <	
): Promise<string>												      <	
```														      <	
														      <	
**Features:**													      <	
- Lists available databases											      <	
- Supports database creation											      <	
- Handles PostgreSQL connection errors										      <	
														      <	
### Module Selection												      <	
**File:** `src/utils/module-utils.ts`										      <	
														      <	
**Key Function:**												      <	
```typescript													      <	
export async function selectPackage(										      <	
  argv: Partial<ParsedArgs>,											      <	
  prompter: Inquirerer,												      <	
  cwd: string,													      <	
  operation: string,												      <	
  log: Logger													      <	
): Promise<string | undefined>											      <	
```														      <	
														      <	
## ðŸ”§ Utility Systems												      <	
														      <	
### Environment Integration											      <	
Commands integrate with environment configuration:								      <	
														      <	
```typescript													      <	
import { getEnvOptions } from '@launchql/env';									      <	
import { getPgEnvOptions, getSpawnEnvWithPg } from 'pg-env';							      <	
														      <	
// Get PostgreSQL environment											      <	
const pgEnv = getPgEnvOptions();										      <	
														      <	
// Override with CLI options											      <	
const cliOverrides = {												      <	
  pg: getPgEnvOptions({ database }),										      <	
  deployment: {													      <	
    useTx: tx !== false,											      <	
    fast: fast !== false,											      <	
    usePlan: argv.usePlan !== false										      <	
  }														      <	
};														      <	
														      <	
const opts = getEnvOptions(cliOverrides);									      <	
```														      <	
														      <	
### Connection Management											      <	
**PostgreSQL Cleanup:**												      <	
```typescript													      <	
const withPgTeardown = (fn: Function, skipTeardown: boolean = false) => 					      <	
  async (...args: any[]) => {											      <	
    try {													      <	
      await fn(...args);											      <	
    } finally {													      <	
      if (!skipTeardown) {											      <	
        await teardownPgPools();										      <	
      }														      <	
    }														      <	
  };														      <	
```														      <	
														      <	
### Error Handling												      <	
Commands provide comprehensive error handling:									      <	
														      <	
```typescript													      <	
try {														      <	
  await project.deploy(opts, target, recursive);								      <	
  log.success('Deployment complete.');										      <	
} catch (error) {												      <	
  log.error('Deployment failed:', error);									      <	
  process.exit(1);												      <	
}														      <	
```														      <	
														      <	
## ðŸ“‹ Command Reference											      <	
														      <	
### Development Commands											      <	
| Command | Purpose | Key Options |										      <	
|---------|---------|-------------|										      <	
| `init` | Initialize workspace/module | `--repo`, `--template-path`, `--from-branch` |				      <	
| `server` | Start development server | `--port`, `--no-postgis` |						      <	
| `explorer` | Launch GraphiQL explorer | `--origin` |								      <	
														      <	
### Database Commands												      <	
| Command | Purpose | Key Options |										      <	
|---------|---------|-------------|										      <	
| `deploy` | Deploy changes | `--createdb`, `--fast`, `--package`, `--to` |					      <	
| `verify` | Verify database state | `--package` |								      <	
| `revert` | Revert changes | `--to` |										      <	
														      <	
### Migration Commands												      <	
| Command | Purpose | Key Options |										      <	
|---------|---------|-------------|										      <	
| `migrate init` | Initialize migration tracking | - |								      <	
| `migrate status` | Check migration status | - |								      <	
| `migrate list` | List all changes | - |									      <	
| `migrate deps` | Show dependencies | - |									      <	
														      <	
### Module Commands												      <	
| Command | Purpose | Key Options |										      <	
|---------|---------|-------------|										      <	
| `install` | Install module dependencies | - |									      <	
| `extension` | Manage dependencies interactively | - |								      <	
| `tag` | Version changes | `--comment`, `--changeName` |							      <	
| `analyze` | Analyze module issues | - |									      <	
| `rename` | Rename module | `--to` |										      <	
														      <	
### Packaging Commands												      <	
| Command | Purpose | Key Options |										      <	
|---------|---------|-------------|										      <	
| `plan` | Generate deployment plans | - |									      <	
| `package` | Package module for distribution | `--no-plan` |							      <	
| `export` | Export migrations | - |										      <	
														      <	
### Utility Commands												      <	
| Command | Purpose | Key Options |										      <	
|---------|---------|-------------|										      <	
| `kill` | Clean up connections/databases | `--no-drop` |							      <	
| `clear` | Clear/cleanup operations | - |									      <	
| `admin-users` | User management | - |										      <	
| `remove` | Remove changes from plan | - |									      <	
														      <	
## ðŸŽ¯ Common Usage Patterns											      <	
														      <	
### 1. New Project Setup											      <	
```bash														      <	
# Initialize workspace												      <	
lql init workspace												      <	
cd my-project													      <	
														      <	
# Create first module												      <	
lql init													      <	
														      <	
# Deploy to database												      <	
lql deploy --createdb												      <	
														      <	
# Start development server											      <	
lql server													      <	
```														      <	
														      <	
### 2. Module Development											      <	
```bash														      <	
# Create new module												      <	
lql init													      <	
														      <	
# Add dependencies												      <	
lql extension													      <	
														      <	
# Deploy changes												      <	
lql deploy													      <	
														      <	
# Verify deployment												      <	
lql verify													      <	
```														      <	
														      <	
### 3. Production Deployment											      <	
```bash														      <	
# Generate deployment plan											      <	
lql plan													      <	
														      <	
# Package module												      <	
lql package													      <	
														      <	
# Deploy to production												      <	
lql deploy --package myapp --to @production									      <	
														      <	
# Verify deployment												      <	
lql verify --package myapp											      <	
```														      <	
														      <	
### 4. Migration Management											      <	
```bash														      <	
# Check migration status											      <	
lql migrate status												      <	
														      <	
# List all changes												      <	
lql migrate list												      <	
														      <	
# Show dependencies												      <	
lql migrate deps												      <	
														      <	
# Revert to specific point											      <	
lql revert --to @v1.0.0												      <	
```														      <	
														      <	
## ðŸ” Integration with Core Classes										      <	
														      <	
### PgpmPackage Integration											      <	
Commands primarily use `PgpmPackage` for operations:								      <	
														      <	
```typescript													      <	
import { PgpmPackage } from '@pgpmjs/core';									      <	
														      <	
const project = new PgpmPackage(cwd);										      <	
														      <	
// Context-aware operations											      <	
if (project.isInWorkspace()) {											      <	
  // Workspace operations											      <	
} else if (project.isInModule()) {										      <	
  // Module operations												      <	
}														      <	
														      <	
// Deploy with options												      <	
await project.deploy(opts, target, recursive);									      <	
```														      <	
														      <	
### PgpmMigrate Integration											      <	
Some commands use `PgpmMigrate` directly:									      <	
														      <	
```typescript													      <	
import { PgpmMigrate } from '@pgpmjs/core';									      <	
														      <	
const migrate = new PgpmMigrate(pgConfig);									      <	
const result = await migrate.status();										      <	
```														      <	
														      <	
## ðŸ“ Key Files to Understand											      <	
														      <	
1. **`src/commands.ts`** - Main command router and setup							      <	
2. **`src/commands/deploy.ts`** - Primary deployment command							      <	
3. **`src/commands/init.ts`** - Workspace/module initialization							      <	
4. **`src/commands/server.ts`** - Development server								      <	
5. **`src/commands/migrate.ts`** - Migration management								      <	
6. **`src/utils/database.ts`** - Database selection utilities							      <	
7. **`src/utils/module-utils.ts`** - Module selection utilities							      <	
8. **`package.json`** - CLI binary configuration								      <	
														      <	
## ðŸŽ¯ Agent Tips												      <	
														      <	
1. **Command Pattern:** All commands follow the same structure - study `deploy.ts` as a template		      <	
2. **Interactive Prompts:** Use `prompter.prompt()` for user input with validation				      <	
3. **Environment Integration:** Always use `getEnvOptions()` for configuration					      <	
4. **Error Handling:** Provide clear error messages and exit codes						      <	
5. **Help Text:** Include comprehensive usage text for each command						      <	
6. **Connection Cleanup:** Use `withPgTeardown()` wrapper for database commands					      <	
														      <	
This guide covers the essential aspects of the CLI package. The CLI serves as the primary interface between users and <
```
