name: CI tests
on:
  push:
    branches:
      - main
      - v1
      - develop-v5
  pull_request:
    branches:
      - main
      - v1
      - develop-v5
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-tests
  cancel-in-progress: true

jobs:
  constructive-tests:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # -- pgpm --
          - package: pgpm/core
            env: {}
          - package: pgpm/env
            env: {}
          - package: pgpm/cli
            env: {}

          # -- packages --
          # - package: packages/cli
          #   env: {}  # codegen.test.ts prompt expectations mismatch
          - package: packages/client
            env:
              TEST_DATABASE_URL: postgres://postgres:password@localhost:5432/postgres
          - package: packages/orm
            env: {}
          - package: packages/url-domains
            env: {}
          - package: packages/query-builder
            env: {}
          - package: packages/csv-to-pg
            env: {}
          - package: packages/smtppostmaster
            env: {}
          - package: packages/oauth
            env: {}
          - package: packages/csrf
            env: {}
          - package: packages/12factor-env
            env: {}
          - package: packages/postmaster
            env: {}

          # -- postgres --
          - package: postgres/pgsql-client
            env: {}
          - package: postgres/pgsql-test
            env: {}
          # - package: postgres/introspectron
          #   env: {}  # graphql v15/v16 DocumentNode type mismatch
          - package: postgres/pg-ast
            env: {}
          - package: postgres/pg-codegen
            env: {}
          - package: postgres/drizzle-orm-test
            env: {}

          # -- graphql --
          - package: graphql/query
            env: {}
          - package: graphql/codegen
            env: {}
          - package: graphql/server-test
            env: {}
          - package: graphql/env
            env: {}
          - package: graphql/server
            env: {}
          - package: graphql/test
            env: {}
          # - package: graphql/playwright-test
          #   env: {}

          # -- graphile --
          - package: graphile/graphile-authz
            env: {}
          - package: graphile/postgraphile-plugin-pgvector
            env: {}
          # - package: graphile/graphile-test
          #   env: {}  # typed mutation tests return undefined (v5 schema change)
          - package: graphile/graphile-search-plugin
            env: {}

          # -- uploads --
          - package: uploads/mime-bytes
            env: {}
          - package: uploads/uuid-hash
            env: {}
          - package: uploads/uuid-stream
            env: {}
          - package: uploads/content-type-stream
            env: {}
          - package: uploads/upload-names
            env: {}
          - package: uploads/etag-hash
            env: {}
          - package: uploads/etag-stream
            env: {}
          - package: uploads/stream-to-etag
            env: {}
          # - package: uploads/s3-streamer
          #   env:
          #     BUCKET_NAME: test-bucket

          # -- jobs --
          # - package: jobs/knative-job-worker
          #   env: {}  # integration test expects knative.internal URL, gets gateway:8080
          # - package: jobs/knative-job-service
          #   env: {}

    env:
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: password
      MINIO_ENDPOINT: http://localhost:9000
      AWS_ACCESS_KEY: minioadmin
      AWS_SECRET_KEY: minioadmin
      AWS_REGION: us-east-1

    services:
      pg_db:
        image: pyramation/postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      minio_cdn:
        image: minio/minio:edge-cicd
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
          - 9001:9001
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Configure Git (for tests)
        run: |
          git config --global user.name "CI Test User"
          git config --global user.email "ci@example.com"

      - name: checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: build
        run: pnpm install

      - name: build
        run: pnpm run build

      - name: seed app_user
        run: |
          pnpm --filter pgpm exec node dist/index.js admin-users bootstrap --yes
          pnpm --filter pgpm exec node dist/index.js admin-users add --test --yes

      - name: Test ${{ matrix.package }}
        run: cd ./${{ matrix.package }} && pnpm test
        env: ${{ matrix.env }}
